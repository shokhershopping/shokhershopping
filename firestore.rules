rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Default: deny all
    match /{document=**} {
      allow read, write: if false;
    }

    // Users: authenticated users can read their own document
    match /users/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false; // Writes only via Admin SDK (API routes)

      match /addresses/{addressId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if false;
      }

      match /preferences/{preferenceId} {
        allow read: if request.auth != null && request.auth.uid == userId;
        allow write: if false;
      }
    }

    // Products: publicly readable
    match /products/{productId} {
      allow read: if true;
      allow write: if false;

      match /variants/{variantId} {
        allow read: if true;
        allow write: if false;
      }
    }

    // Categories: publicly readable
    match /categories/{categoryId} {
      allow read: if true;
      allow write: if false;
    }

    // Orders: users can read their own orders
    match /orders/{orderId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if false;

      match /items/{itemId} {
        allow read: if request.auth != null;
        allow write: if false;
      }
    }

    // Coupons: authenticated users can read
    match /coupons/{couponId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // Reviews: publicly readable
    match /reviews/{reviewId} {
      allow read: if true;
      allow write: if false;
    }

    // Wishlists: users can read their own
    match /wishlists/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false;
    }

    // Carts: users can read their own
    match /carts/{userId} {
      allow read: if request.auth != null && request.auth.uid == userId;
      allow write: if false;
    }

    // Notifications: authenticated users can read
    match /notifications/{notificationId} {
      allow read: if request.auth != null;
      allow write: if false;

      match /recipients/{recipientId} {
        allow read: if request.auth != null;
        allow write: if false;
      }
    }

    // Invoices: authenticated users only
    match /invoices/{invoiceId} {
      allow read: if request.auth != null;
      allow write: if false;
    }

    // QnA: publicly readable
    match /qna/{qnaId} {
      allow read: if true;
      allow write: if false;

      match /replies/{replyId} {
        allow read: if true;
        allow write: if false;
      }
    }

    // Affiliates: users can read their own
    match /affiliates/{affiliateId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow write: if false;

      match /{subcollection}/{docId} {
        allow read: if request.auth != null;
        allow write: if false;
      }
    }
  }
}
